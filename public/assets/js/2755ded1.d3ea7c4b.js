"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[45264],{22724:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"web-app/features/bottom-board-management","title":"bottom-board-management","description":"This document describes the technical implementation of the hive bottom board feature for varroa mite monitoring. The feature spans three microservices: swarm-api, image-splitter, and web-app.","source":"@site/docs/web-app/features/bottom-board-management.md","sourceDirName":"web-app/features","slug":"/web-app/features/bottom-board-management","permalink":"/docs/web-app/features/bottom-board-management","draft":false,"unlisted":false,"editUrl":"https://github.com/gratheon/website/tree/main/packages/create-docusaurus/templates/shared/docs/web-app/features/bottom-board-management.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"User Profile Editing - Technical Documentation","permalink":"/docs/web-app/features/user-profile-editing"},"next":{"title":"gate-video-stream","permalink":"/docs/web-app/\ud83e\udd5e DB schemas/gate-video-stream"}}');var l=i(74848),r=i(28453);const d={},o=void 0,t={},a=[{value:"Architecture",id:"architecture",level:2},{value:"Service Dependencies",id:"service-dependencies",level:3},{value:"Data Flow",id:"data-flow",level:3},{value:"Database Schema",id:"database-schema",level:2},{value:"swarm-api Schema",id:"swarm-api-schema",level:3},{value:"boxes table",id:"boxes-table",level:4},{value:"image-splitter Schema",id:"image-splitter-schema",level:3},{value:"files_box_rel table",id:"files_box_rel-table",level:4},{value:"Relationships",id:"relationships",level:4},{value:"GraphQL API",id:"graphql-api",level:2},{value:"swarm-api",id:"swarm-api",level:3},{value:"Add Box Mutation",id:"add-box-mutation",level:4},{value:"image-splitter",id:"image-splitter",level:3},{value:"Upload File Mutation",id:"upload-file-mutation",level:4},{value:"Link File to Box Mutation",id:"link-file-to-box-mutation",level:4},{value:"Frontend Implementation",id:"frontend-implementation",level:2},{value:"BottomBox Component",id:"bottombox-component",level:3},{value:"Integration Points",id:"integration-points",level:3},{value:"Backend Implementation",id:"backend-implementation",level:2},{value:"swarm-api (Go)",id:"swarm-api-go",level:3},{value:"Box Model",id:"box-model",level:4},{value:"image-splitter (TypeScript)",id:"image-splitter-typescript",level:3},{value:"boxFile Model",id:"boxfile-model",level:4},{value:"Resolver",id:"resolver",level:4},{value:"Inspection Versioning",id:"inspection-versioning",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"SQL Queries",id:"sql-queries",level:3},{value:"Job Queue Integration",id:"job-queue-integration",level:2},{value:"Varroa Detection Job",id:"varroa-detection-job",level:3},{value:"Deployment",id:"deployment",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Migration Steps",id:"migration-steps",level:3},{value:"Verification",id:"verification",level:3},{value:"Testing",id:"testing",level:2},{value:"Unit Tests",id:"unit-tests",level:3},{value:"Integration Test Flow",id:"integration-test-flow",level:3},{value:"Manual Test",id:"manual-test",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Future Enhancements",id:"future-enhancements",level:2},{value:"Phase 2: Display Images",id:"phase-2-display-images",level:3},{value:"Phase 3: Varroa Detection",id:"phase-3-varroa-detection",level:3},{value:"Phase 4: Analytics",id:"phase-4-analytics",level:3},{value:"Related Documentation",id:"related-documentation",level:2},{value:"Change Log",id:"change-log",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"This document describes the technical implementation of the hive bottom board feature for varroa mite monitoring. The feature spans three microservices: swarm-api, image-splitter, and web-app."}),"\n",(0,l.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,l.jsx)(n.h3,{id:"service-dependencies",children:"Service Dependencies"}),"\n",(0,l.jsx)(n.mermaid,{value:"graph TB\n    A[web-app] --\x3e|GraphQL| B[graphql-router]\n    B --\x3e|addBox| C[swarm-api]\n    B --\x3e|uploadFrameSide| D[image-splitter]\n    B --\x3e|addFileToBox| D\n    C --\x3e|stores| E[(MySQL - boxes)]\n    D --\x3e|stores| F[(MySQL - files_box_rel)]\n    D --\x3e|uploads| G[AWS S3]\n    D --\x3e|queues| H[Job Queue]"}),"\n",(0,l.jsx)(n.h3,{id:"data-flow",children:"Data Flow"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"User creates bottom box"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"web-app \u2192 graphql-router \u2192 swarm-api"}),"\n",(0,l.jsxs)(n.li,{children:["Creates record in ",(0,l.jsx)(n.code,{children:"boxes"})," table with ",(0,l.jsx)(n.code,{children:"type = 'BOTTOM'"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"User uploads image"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"web-app \u2192 graphql-router \u2192 image-splitter"}),"\n",(0,l.jsxs)(n.li,{children:["Step 1: ",(0,l.jsx)(n.code,{children:"uploadFrameSide"})," uploads to S3, returns ",(0,l.jsx)(n.code,{children:"fileId"})]}),"\n",(0,l.jsxs)(n.li,{children:["Step 2: ",(0,l.jsx)(n.code,{children:"addFileToBox"})," links file to box in ",(0,l.jsx)(n.code,{children:"files_box_rel"})]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Image processing"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"image-splitter queues varroa detection job"}),"\n",(0,l.jsx)(n.li,{children:"Job processes image asynchronously"}),"\n",(0,l.jsxs)(n.li,{children:["Results stored in ",(0,l.jsx)(n.code,{children:"detectedObjects"})," JSON field"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"database-schema",children:"Database Schema"}),"\n",(0,l.jsx)(n.h3,{id:"swarm-api-schema",children:"swarm-api Schema"}),"\n",(0,l.jsx)(n.h4,{id:"boxes-table",children:"boxes table"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `boxes` (\n  `id` int unsigned NOT NULL AUTO_INCREMENT,\n  `user_id` int unsigned NOT NULL,\n  `hive_id` int NOT NULL,\n  `active` tinyint(1) NOT NULL DEFAULT '1',\n  `color` varchar(10) DEFAULT '#ffc848',\n  `position` mediumint DEFAULT NULL,\n  `type` enum('SUPER','DEEP','GATE','VENTILATION','QUEEN_EXCLUDER','HORIZONTAL_FEEDER','BOTTOM') \n         CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL DEFAULT 'DEEP',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Migration"}),": ",(0,l.jsx)(n.code,{children:"migrations/20251201025115_add_bottom_box_type.sql"})]}),"\n",(0,l.jsx)(n.h3,{id:"image-splitter-schema",children:"image-splitter Schema"}),"\n",(0,l.jsx)(n.h4,{id:"files_box_rel-table",children:"files_box_rel table"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `files_box_rel` (\n  `box_id` int unsigned NOT NULL,\n  `file_id` int unsigned NOT NULL,\n  `user_id` int unsigned NOT NULL,\n  `inspection_id` INT NULL DEFAULT NULL,\n  `added_time` datetime DEFAULT CURRENT_TIMESTAMP,\n  INDEX (`user_id`, `box_id`, `inspection_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Migration"}),": ",(0,l.jsx)(n.code,{children:"migrations/018-box-files.sql"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Purpose"}),": Links uploaded files to specific boxes with inspection versioning support."]}),"\n",(0,l.jsx)(n.h4,{id:"relationships",children:"Relationships"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"box_id"})," \u2192 ",(0,l.jsx)(n.code,{children:"swarm-api.boxes.id"})," (foreign service reference)"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"file_id"})," \u2192 ",(0,l.jsx)(n.code,{children:"image-splitter.files.id"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"user_id"})," \u2192 user ownership"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"inspection_id"})," \u2192 ",(0,l.jsx)(n.code,{children:"swarm-api.inspections.id"})," (NULL = current state)"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"graphql-api",children:"GraphQL API"}),"\n",(0,l.jsx)(n.h3,{id:"swarm-api",children:"swarm-api"}),"\n",(0,l.jsx)(n.h4,{id:"add-box-mutation",children:"Add Box Mutation"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-graphql",children:"mutation addBox($hiveId: ID!, $position: Int!, $type: BoxType!) {\n  addBox(hiveId: $hiveId, position: $position, type: $type) {\n    id\n    type\n    position\n    color\n  }\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Variables"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "hiveId": "123",\n  "position": 0,\n  "type": "BOTTOM"\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Implementation"}),": ",(0,l.jsx)(n.code,{children:"graph/schema.resolvers.go::AddBox()"})]}),"\n",(0,l.jsx)(n.h3,{id:"image-splitter",children:"image-splitter"}),"\n",(0,l.jsx)(n.h4,{id:"upload-file-mutation",children:"Upload File Mutation"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-graphql",children:"mutation uploadFrameSide($file: Upload!) {\n  uploadFrameSide(file: $file) {\n    id\n    url\n    resizes {\n      id\n      url\n      max_dimension_px\n    }\n  }\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Returns"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "data": {\n    "uploadFrameSide": {\n      "id": "456",\n      "url": "https://s3.../original.jpg",\n      "resizes": [...]\n    }\n  }\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Implementation"}),": ",(0,l.jsx)(n.code,{children:"src/graphql/upload-frame-side.ts"})]}),"\n",(0,l.jsx)(n.h4,{id:"link-file-to-box-mutation",children:"Link File to Box Mutation"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-graphql",children:"mutation addFileToBox($boxId: ID!, $fileId: ID!, $hiveId: ID!) {\n  addFileToBox(boxId: $boxId, fileId: $fileId, hiveId: $hiveId)\n}\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Variables"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "boxId": "123",\n  "fileId": "456",\n  "hiveId": "789"\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Implementation"}),": ",(0,l.jsx)(n.code,{children:"src/graphql/resolvers.ts::addFileToBox()"})]}),"\n",(0,l.jsx)(n.h2,{id:"frontend-implementation",children:"Frontend Implementation"}),"\n",(0,l.jsx)(n.h3,{id:"bottombox-component",children:"BottomBox Component"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Location"}),": ",(0,l.jsx)(n.code,{children:"web-app/src/page/hiveEdit/bottomBox/BottomBox.tsx"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Key Features"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"File upload with validation"}),"\n",(0,l.jsx)(n.li,{children:"Two-step mutation process"}),"\n",(0,l.jsx)(n.li,{children:"Error handling"}),"\n",(0,l.jsx)(n.li,{children:"Loading states"}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Code Structure"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:'export default function BottomBox({ boxId, hiveId }) {\n  // Step 1: Upload file\n  const [uploadFile] = useUploadMutation(...)\n  \n  // Step 2: Link to box\n  const [addFileToBoxMutation] = useMutation(...)\n  \n  async function onFileSelect(event) {\n    const file = event.target.files?.[0]\n    \n    // Upload file to S3\n    const uploadResult = await uploadFile({ file })\n    const fileId = uploadResult.data.uploadFrameSide.id\n    \n    // Link file to box\n    await addFileToBoxMutation({ boxId, fileId, hiveId })\n  }\n  \n  return (\n    <div>\n      <input type="file" onChange={onFileSelect} />\n      {data && <img src={data.uploadFrameSide.url} />}\n    </div>\n  )\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"integration-points",children:"Integration Points"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"hiveButtons.tsx"}),': Adds "Add bottom" button']}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"<Button onClick={() => onBoxAdd(boxTypes.BOTTOM)}>\n  <span><T>Add bottom</T></span>\n</Button>\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"index.tsx"}),": Renders BottomBox component"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"{box && box.type === boxTypes.BOTTOM && (\n  <BottomBox boxId={boxId} hiveId={hiveId} />\n)}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"backend-implementation",children:"Backend Implementation"}),"\n",(0,l.jsx)(n.h3,{id:"swarm-api-go",children:"swarm-api (Go)"}),"\n",(0,l.jsx)(n.h4,{id:"box-model",children:"Box Model"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Location"}),": ",(0,l.jsx)(n.code,{children:"graph/model/box.go"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Create()"})," - Creates new box with type validation"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ListByHive()"})," - Fetches boxes for a hive"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"Get()"})," - Retrieves single box"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Type Constants"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-go",children:'const (\n    BoxTypeDeep             BoxType = "DEEP"\n    BoxTypeSuper            BoxType = "SUPER"\n    BoxTypeGate             BoxType = "GATE"\n    BoxTypeVentilation      BoxType = "VENTILATION"\n    BoxTypeQueenExcluder    BoxType = "QUEEN_EXCLUDER"\n    BoxTypeHorizontalFeeder BoxType = "HORIZONTAL_FEEDER"\n    BoxTypeBottom           BoxType = "BOTTOM"\n)\n'})}),"\n",(0,l.jsx)(n.h3,{id:"image-splitter-typescript",children:"image-splitter (TypeScript)"}),"\n",(0,l.jsx)(n.h4,{id:"boxfile-model",children:"boxFile Model"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Location"}),": ",(0,l.jsx)(n.code,{children:"src/models/boxFile.ts"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Key Methods"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"export default {\n  async addBoxRelation(fileId, boxId, userId, inspectionId = null) {\n    await storage().query(\n      sql`INSERT INTO files_box_rel \n          (file_id, box_id, user_id, inspection_id) \n          VALUES (${fileId}, ${boxId}, ${userId}, ${inspectionId})`\n    );\n  },\n  \n  async getBoxFiles(boxId, userId, inspectionId = null) {\n    // Returns files for specific box\n  }\n}\n"})}),"\n",(0,l.jsx)(n.h4,{id:"resolver",children:"Resolver"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Location"}),": ",(0,l.jsx)(n.code,{children:"src/graphql/resolvers.ts"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"addFileToBox: async (_, {boxId, fileId, hiveId}, {uid}) => {\n  await boxFileModel.addBoxRelation(fileId, boxId, uid);\n  await fileModel.addHiveRelation(fileId, hiveId, uid);\n  return true;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"inspection-versioning",children:"Inspection Versioning"}),"\n",(0,l.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Current State"}),": Images have ",(0,l.jsx)(n.code,{children:"inspection_id = NULL"})]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Create Inspection"}),":","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Current images are cloned"}),"\n",(0,l.jsxs)(n.li,{children:["Clones get new ",(0,l.jsx)(n.code,{children:"inspection_id"})]}),"\n",(0,l.jsxs)(n.li,{children:["Original images remain with ",(0,l.jsx)(n.code,{children:"NULL"})," (becomes new current state)"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Historical View"}),": Query with specific ",(0,l.jsx)(n.code,{children:"inspection_id"})]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"sql-queries",children:"SQL Queries"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Get current images"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM files_box_rel \nWHERE box_id = ? AND user_id = ? AND inspection_id IS NULL;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Get historical images"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM files_box_rel \nWHERE box_id = ? AND user_id = ? AND inspection_id = ?;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"job-queue-integration",children:"Job Queue Integration"}),"\n",(0,l.jsx)(n.h3,{id:"varroa-detection-job",children:"Varroa Detection Job"}),"\n",(0,l.jsx)(n.p,{children:"When file is uploaded, a varroa detection job is queued:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-typescript",children:"await jobs.addJob(TYPE_VARROA, fileId);\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Job Type"}),": ",(0,l.jsx)(n.code,{children:"TYPE_VARROA = 'varroa'"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Processing"}),":"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Job worker picks up job from queue"}),"\n",(0,l.jsx)(n.li,{children:"Downloads image from S3"}),"\n",(0,l.jsx)(n.li,{children:"Runs varroa detection model"}),"\n",(0,l.jsxs)(n.li,{children:["Stores results in ",(0,l.jsx)(n.code,{children:"detectedObjects"})," JSON field"]}),"\n",(0,l.jsx)(n.li,{children:"Updates job status to complete"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,l.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"MySQL database for both services"}),"\n",(0,l.jsx)(n.li,{children:"AWS S3 bucket configured"}),"\n",(0,l.jsx)(n.li,{children:"Redis for job queue"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"migration-steps",children:"Migration Steps"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Deploy swarm-api"}),":"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd swarm-api\njust migrate-db-dev\n# Applies: migrations/20251201025115_add_bottom_box_type.sql\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"2",children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Deploy image-splitter"}),":"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd image-splitter\njust stop && just start\n# Auto-runs: migrations/018-box-files.sql\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"3",children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Deploy web-app"}),":"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd web-app\npnpm build\n# Upload dist/ to hosting\n"})}),"\n",(0,l.jsxs)(n.ol,{start:"4",children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Restart graphql-router"}),":"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker restart gratheon-graphql-router-1\n"})}),"\n",(0,l.jsx)(n.h3,{id:"verification",children:"Verification"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- Check box type enum\nSHOW COLUMNS FROM boxes LIKE 'type';\n\n-- Check files_box_rel table\nDESCRIBE files_box_rel;\n\n-- Test data flow\nINSERT INTO boxes (user_id, hive_id, type, position) \nVALUES (1, 1, 'BOTTOM', 0);\n\n-- Should return the box\nSELECT * FROM boxes WHERE type = 'BOTTOM';\n"})}),"\n",(0,l.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,l.jsx)(n.h3,{id:"unit-tests",children:"Unit Tests"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"swarm-api"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd swarm-api\ngo test ./...\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"image-splitter"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd image-splitter\nnpm test\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"web-app"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd web-app\npnpm test:unit\n"})}),"\n",(0,l.jsx)(n.h3,{id:"integration-test-flow",children:"Integration Test Flow"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Create hive via API"}),"\n",(0,l.jsx)(n.li,{children:"Add BOTTOM box to hive"}),"\n",(0,l.jsx)(n.li,{children:"Upload image via BottomBox component"}),"\n",(0,l.jsxs)(n.li,{children:["Verify:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"File exists in S3"}),"\n",(0,l.jsxs)(n.li,{children:["Record in ",(0,l.jsx)(n.code,{children:"files"})," table"]}),"\n",(0,l.jsxs)(n.li,{children:["Record in ",(0,l.jsx)(n.code,{children:"files_box_rel"})," table"]}),"\n",(0,l.jsxs)(n.li,{children:["Record in ",(0,l.jsx)(n.code,{children:"files_hive_rel"})," table"]}),"\n",(0,l.jsx)(n.li,{children:"Varroa job queued"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"manual-test",children:"Manual Test"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Navigate to hive in web-app"}),"\n",(0,l.jsx)(n.li,{children:'Click "Add bottom" button'}),"\n",(0,l.jsx)(n.li,{children:"Verify bottom box appears in structure"}),"\n",(0,l.jsx)(n.li,{children:"Click on bottom box"}),"\n",(0,l.jsx)(n.li,{children:"Upload image file"}),"\n",(0,l.jsx)(n.li,{children:"Check database:"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM files_box_rel \nORDER BY added_time DESC LIMIT 1;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsx)(n.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Issue"}),": \"Data truncated for column 'type'\""]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Cause"}),": Migration not run"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Fix"}),": Run ",(0,l.jsx)(n.code,{children:"just migrate-db-dev"})," in swarm-api"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Issue"}),': "Unknown field addFileToBox"']}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Cause"}),": graphql-router not restarted"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Fix"}),": Restart graphql-router to reload schema"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Issue"}),': "Unable to resolve table files_box_rel"']}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Cause"}),": Migration not run in image-splitter"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Fix"}),": Rebuild image-splitter container"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Issue"}),": Image uploads but not linked"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Cause"}),": Missing ",(0,l.jsx)(n.code,{children:"addFileToBox"})," call"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Fix"}),": Check BottomBox component calls both mutations"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,l.jsx)(n.h3,{id:"phase-2-display-images",children:"Phase 2: Display Images"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Add query to fetch box images"}),"\n",(0,l.jsx)(n.li,{children:"Display images in UI"}),"\n",(0,l.jsx)(n.li,{children:"Show upload history"}),"\n",(0,l.jsx)(n.li,{children:"Image deletion capability"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"phase-3-varroa-detection",children:"Phase 3: Varroa Detection"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Implement varroa counting model"}),"\n",(0,l.jsx)(n.li,{children:"Display count on images"}),"\n",(0,l.jsx)(n.li,{children:"Show detection regions"}),"\n",(0,l.jsx)(n.li,{children:"Confidence scores"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"phase-4-analytics",children:"Phase 4: Analytics"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Historical trend charts"}),"\n",(0,l.jsx)(n.li,{children:"Treatment correlation"}),"\n",(0,l.jsx)(n.li,{children:"Predictive alerts"}),"\n",(0,l.jsx)(n.li,{children:"Comparison across hives"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"[Bottom Board User Guide](../../about/products/web_app/starter-tier/\ud83e\uddee Hive bottom board & varroa monitoring.md)"}),"\n",(0,l.jsx)(n.li,{children:"[DB Schemas](./\ud83e\udd5e DB schemas/)"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"change-log",children:"Change Log"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"2025-12-01"}),": Initial implementation","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Added BOTTOM box type"}),"\n",(0,l.jsx)(n.li,{children:"Created files_box_rel table"}),"\n",(0,l.jsx)(n.li,{children:"Implemented upload flow"}),"\n",(0,l.jsx)(n.li,{children:"Added BottomBox component"}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>o});var s=i(96540);const l={},r=s.createContext(l);function d(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);